# System Audit (Аудит систем)

Шаблоны для детального аудита архитектуры систем: ручной и автоматический.

---

## Быстрый старт

**Комбинированный подход (рекомендуется):**
1. Запустите автоматическую валидацию: `archlint validate`
2. Проведите ручной аудит по [system-audit.md](system-audit.md)
3. Объедините результаты
4. Составьте план улучшений

**Только ручной аудит:**
1. Используйте шаблон [system-audit.md](system-audit.md)
2. Заполните 12 разделов
3. Дайте оценки (1-5)
4. Составьте план улучшений

**Только автоматический:**
1. Настройте `.archlint.yaml`
2. Запустите: `archlint validate`
3. Используйте [audit.md](audit.md) как шаблон отчета

---

## Файлы

### [system-audit.md](system-audit.md)
**Шаблон для детального ручного аудита системы**

**Объем:** 12 разделов, 450+ строк

**Что внутри:**

1. **Обзор системы**
   - Назначение и границы
   - Контекстная диаграмма (C4 Level 1)
   - Внешние системы и пользователи

2. **Структура системы**
   - Каталог сервисов
   - Диаграмма контейнеров (C4 Level 2)
   - Bounded Contexts (если DDD)
   - Оценка структуры

3. **Взаимодействие сервисов**
   - Синхронные взаимодействия (REST, gRPC)
   - Асинхронные взаимодействия (Kafka, RabbitMQ)
   - Матрица зависимостей
   - Критические пути (latency, риски)

4. **Паттерны и практики**
   - Используемые паттерны (API Gateway, Circuit Breaker, Saga, CQRS, etc.)
   - ADR (Architecture Decision Records)
   - Антипаттерны (Distributed Monolith, Shared Database, etc.)

5. **Данные и хранилища**
   - Базы данных (PostgreSQL, MongoDB, ClickHouse)
   - Кэширование (Redis, Memcached)
   - Консистентность данных (Strong, Eventual)

6. **Тестовое покрытие**
   - Unit / Integration / E2E тесты
   - Contract Testing
   - Нагрузочное тестирование
   - Chaos Engineering

7. **Observability**
   - Метрики (RED, USE, Business metrics)
   - Логирование (ELK, Loki, correlation ID)
   - Трейсинг (Jaeger, Tempo)
   - Алертинг (PagerDuty, Slack, runbooks)

8. **Устойчивость и отказоустойчивость**
   - Single Points of Failure
   - Graceful Degradation
   - Масштабируемость
   - Disaster Recovery (RTO, RPO)

9. **Безопасность**
   - Аутентификация и авторизация
   - Защита данных (шифрование, маскирование PII)
   - Известные уязвимости

10. **Сводка проблем и рекомендаций**
    - Критические проблемы (P0)
    - Важные улучшения (P1)
    - Желательные улучшения (P2)

11. **План улучшений**
    - Ближайшие действия (1-2 недели)
    - Среднесрочные (1-3 месяца)
    - Долгосрочные (3+ месяца)

12. **Заключение**
    - Общая оценка системы (X/5)
    - Ключевые выводы
    - Рекомендация следующего аудита

**Когда использовать:**
- Во время фазы "Аудит" процесса приёмки проекта
- Для глубокого анализа существующей системы
- При подготовке к миграции или рефакторингу
- Для ежегодного/квартального review архитектуры

**Оценки:**
- Архитектурная зрелость (1-5)
- Операционная готовность (1-5)
- Устойчивость к отказам (1-5)
- Масштабируемость (1-5)
- Безопасность (1-5)

**Результат:**
- Объективная картина состояния системы
- Список критичных проблем с приоритетами
- Приоритизированный план улучшений
- Оценка готовности к production/scale

---

### [audit.md](audit.md)
**Шаблон отчета по автоматической валидации архитектуры**

**Что внутри:**
- Результаты проверки 215 метрик качества
- Категории: ERROR, WARNING, PASSED, INFO
- Конкретные проблемы с рекомендациями

**Метрики:**

**1. Связность и coupling**
- max_fan_out - один компонент зависит от слишком многих
- coupling - afferent (Ca) и efferent (Ce) coupling
- instability - метрика нестабильности компонента

**2. Архитектурные принципы**
- layer_violations - нарушения слоёв (handler -> repository)
- god_class - слишком много методов и зависимостей
- interface_segregation - интерфейсы > 5 методов

**3. Domain-Driven Design**
- use_case_purity - смешивание бизнес-логики с инфраструктурой
- bounded_context_leakage - утечка деталей между контекстами
- service_autonomy - прямые зависимости между сервисами

**4. Метрики изменений**
- change_propagation - как изменения распространяются
- hotspot_detection - частота изменений компонента
- stability_violations - зависимости нестабильных от нестабильных

**5. Топологические метрики**
- betti_numbers - топологическая сложность
- euler_characteristic - характеристика Эйлера графа
- forman_curvature - кривизна рёбер (структурная напряжённость)
- spectral_gap - влияние на распространение изменений

**6. Другие метрики**
- hub_nodes - узлы с слишком многими связями
- articulation_points - точки сочленения (SPOF)
- circular_dependencies - циклические зависимости
- feature_envy - метод использует чужие данные

**Инструмент:** archlint validate

```bash
# Базовая валидация
archlint validate

# С конфигом
archlint validate --config .archlint.yaml

# С выводом в файл
archlint validate > docs/audits/2026-01-audit.md
```

**Когда использовать:**
- Дополнение к ручному аудиту system-audit.md
- Для объективной оценки качества кода
- В CI/CD для continuous architecture validation
- Для отслеживания архитектурной деградации

**Результат:**
- Количество ERROR/WARNING/PASSED
- Список проблемных компонентов с метриками
- Конкретные рекомендации: "Что улучшится"
- Список успешных проверок

---

## Подходы к аудиту

### Подход 1: Комбинированный (рекомендуется)

**Шаг 1: Автоматическая валидация**
```bash
archlint validate --config .archlint.yaml > audit-auto.md
```

**Шаг 2: Ручной аудит**
- Заполнить system-audit.md
- Сфокусироваться на том, что автоматика не видит:
  - Бизнес-контекст
  - ADR и архитектурные решения
  - Операционная готовность (runbooks, DR)
  - Команда и knowledge transfer

**Шаг 3: Объединение**
- Критичные проблемы из автоматики -> в system-audit.md секция 10
- Метрики из автоматики -> в system-audit.md секция 3
- Общие выводы

**Преимущества:**
- Объективность (автоматика)
- Контекст (ручной)
- Полнота картины

---

### Подход 2: Только ручной

**Когда использовать:**
- Нет доступа к коду (только документация и мониторинг)
- Аудит процессов, а не кода
- Высокоуровневый обзор для руководства

**Шаги:**
1. Заполнить все 12 разделов system-audit.md
2. Дать оценки (1-5)
3. Составить план улучшений

---

### Подход 3: Только автоматический

**Когда использовать:**
- Continuous validation в CI/CD
- Быстрая проверка изменений
- Отслеживание метрик во времени

**Шаги:**
1. Настроить `.archlint.yaml`
2. Запустить `archlint validate`
3. Проанализировать ERROR и WARNING

**Ограничения:**
- Видит только код, не видит контекст
- Не знает про бизнес-требования
- Не оценивает операционную готовность

---

## Примеры использования

### Пример 1: Приёмка проекта

**Контекст:** Принимаем проект в надзор

**Что делаем:**
1. Комбинированный аудит
2. Автоматика: `archlint validate`
3. Ручной: заполняем system-audit.md
4. Фиксируем критичные проблемы
5. Решение о приёмке: Принят/С оговорками/Не принят

**Результат:**
- Отчёт system-audit.md с оценкой X/5
- Список блокеров для приёмки
- План улучшений на 3 месяца

---

### Пример 2: Квартальный review

**Контекст:** Ежеквартальная проверка архитектуры

**Что делаем:**
1. Быстрая автоматическая валидация
2. Сравнение с предыдущим кварталом
3. Фокус на изменениях и деградации
4. Обновление плана улучшений

**Результат:**
- Тренды метрик (улучшение/ухудшение)
- Новые проблемы
- Прогресс по плану улучшений

---

### Пример 3: Перед миграцией

**Контекст:** Планируем миграцию на микросервисы

**Что делаем:**
1. Детальный ручной аудит
2. Фокус на bounded contexts и coupling
3. Автоматика для подтверждения метриками
4. План миграции с приоритетами

**Результат:**
- Карта зависимостей
- Приоритеты разделения на сервисы
- Оценка сложности миграции

---

## Метрики и пороги

### Критичные метрики (ERROR если превышено)

| Метрика | Порог | Что означает |
|---------|-------|-------------|
| max_fan_out | 5 | Компонент зависит от > 5 других |
| coupling (Ca/Ce) | 10 | Слишком много входящих/исходящих зависимостей |
| layer_violations | 0 | Нарушение архитектурных слоёв |
| god_class methods | 20 | Слишком много методов в одном классе |
| god_class deps | 15 | Слишком много зависимостей |
| interface methods | 5 | Интерфейс слишком большой |
| circular_dependencies | 0 | Циклические зависимости |

### Метрики качества (оценка)

| Метрика | Норма | Что показывает |
|---------|-------|----------------|
| test_coverage | >= 70% | Покрытие тестами |
| instability | 0.0-1.0 | Стабильность компонента (0=стабильный) |
| abstractness | 0.0-1.0 | Абстрактность компонента |
| distance_from_main_sequence | 0.0-0.5 | Отклонение от идеала |

---

## Best Practices

### Ручной аудит
1. **Начните с обзора** - поймите систему в целом перед деталями
2. **Используйте диаграммы** - C4 помогает структурировать мышление
3. **Фокусируйтесь на рисках** - не все проблемы критичны
4. **Давайте план** - не только проблемы, но и решения
5. **Будьте объективны** - опирайтесь на метрики, не впечатления

### Автоматическая валидация
1. **Настройте пороги** - адаптируйте под свой проект
2. **Интегрируйте в CI/CD** - проверяйте на каждом PR
3. **Отслеживайте тренды** - важна динамика, не абсолют
4. **Исправляйте ERROR** - WARNING можно отложить
5. **Документируйте исключения** - почему игнорируем метрику

### Комбинированный подход
1. **Автоматика первой** - быстрый overview
2. **Ручной для контекста** - понять причины проблем
3. **Объединяйте результаты** - единый отчёт
4. **Приоритизируйте** - не всё критично
5. **Повторяйте регулярно** - отслеживайте прогресс

---

## FAQ

**Q: Как часто проводить аудит?**

A: Зависит от зрелости:
- Новые проекты: каждые 3 месяца
- Стабильные: каждые 6-12 месяцев
- После критичных изменений: ad-hoc
- В CI/CD: автоматически на каждом PR

**Q: Сколько времени занимает ручной аудит?**

A: Обычно 3-7 дней:
- День 1-2: Обзор архитектуры и сбор информации
- День 3-4: Глубокое погружение
- День 5-7: Анализ и составление отчёта

**Q: Нужно ли заполнять все секции system-audit.md?**

A: Стремитесь к полноте. Минимум для приёмки:
- Структура системы
- Взаимодействие сервисов
- Observability
- Безопасность

**Q: Что делать если много ERROR в автоматической валидации?**

A: Приоритизируйте:
1. Сначала layer_violations (архитектурно критичны)
2. Потом coupling и fan_out (влияют на поддерживаемость)
3. Затем остальное

**Q: Можно ли игнорировать некоторые метрики?**

A: Да, но документируйте в `.archlint.yaml`:
```yaml
ignore:
  - metric: god_class
    component: LegacyService
    reason: "Постепенный рефакторинг, план на Q2"
```

---

## Связанные ресурсы

**Приёмка проектов:**
- [../project-handover/](../project-handover/) - процесс и чеклист приёмки

**Индустриальные практики:**
- [TOGAF Architecture Review](https://www.opengroup.org/architecture/togaf7-doc/arch/p4/comp/clists/syseng.htm)
- [C4 Model](https://c4model.com/)
- Software Architecture in Practice (Bass, Clements, Kazman)

**Метрики:**
- [Robert Martin's Metrics](https://en.wikipedia.org/wiki/Software_package_metrics)
- [Cyclomatic Complexity](https://en.wikipedia.org/wiki/Cyclomatic_complexity)
- [Cognitive Complexity](https://www.sonarsource.com/resources/cognitive-complexity/)

---

*Шаблоны созданы на основе индустриальных практик и реального опыта аудита систем различного масштаба.*
